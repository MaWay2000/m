
const API=(typeof browser!=='undefined')?browser:chrome;
const DEFAULTS={strictOrder:true,showTimeline:true,debugLogs:false,openTaskEnabled:true,openTaskDelaySec:1,openTaskSound:true,openTaskNewWindow:true,openTaskFocus:true,openTaskUseHistory:true,openTaskOnlyJustNow:true,createEnabled:true,createDelaySec:1,createSound:true,viewEnabled:true,viewDelaySec:1,viewSound:true,viewCloseEnabled:false,viewCloseDelaySec:2,mergeEnabled:false,mergeDelaySec:3,mergeSound:true,mergeCloseEnabled:false,mergeCloseDelaySec:2,confirmEnabled:false,confirmDelaySec:3,confirmSound:true};
function $(id){return document.getElementById(id);}function clamp(v){v=Number(v)||1;return Math.max(1,Math.min(60,v));}
function load(){API.storage.local.get(DEFAULTS,(c)=>{['strictOrder','showTimeline','openTaskEnabled','openTaskSound','openTaskNewWindow','openTaskFocus','openTaskUseHistory','openTaskOnlyJustNow','createEnabled','createSound','viewEnabled','viewSound','viewCloseEnabled','mergeEnabled','mergeSound','mergeCloseEnabled','confirmEnabled','confirmSound'].forEach(id=>$(id).checked=!!c[id]);['openTaskDelaySec','createDelaySec','viewDelaySec','viewCloseDelaySec','mergeDelaySec','mergeCloseDelaySec','confirmDelaySec'].forEach(id=>$(id).value=clamp(c[id]));});}
function save(){const c={};['strictOrder','showTimeline','openTaskEnabled','openTaskSound','openTaskNewWindow','openTaskFocus','openTaskUseHistory','openTaskOnlyJustNow','createEnabled','createSound','viewEnabled','viewSound','viewCloseEnabled','mergeEnabled','mergeSound','mergeCloseEnabled','confirmEnabled','confirmSound'].forEach(id=>c[id]=$(id).checked);['openTaskDelaySec','createDelaySec','viewDelaySec','viewCloseDelaySec','mergeDelaySec','mergeCloseDelaySec','confirmDelaySec'].forEach(id=>c[id]=clamp($(id).value));API.storage.local.set(c);}
document.addEventListener('DOMContentLoaded',()=>{load();document.querySelectorAll('input,button').forEach(el=>el.addEventListener('change',save));document.getElementById('openOptions').addEventListener('click',e=>{e.preventDefault();if(API.runtime.openOptionsPage)API.runtime.openOptionsPage();});document.getElementById('resetFlow').addEventListener('click',()=>{API.runtime.sendMessage({type:'RESET_FLOW'},()=>{window.close();});});});